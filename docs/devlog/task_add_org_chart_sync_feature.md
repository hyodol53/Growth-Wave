# 개발 로그: 조직도 및 사용자 일괄 동기화 기능 개발

**관련 요구사항:** `FR-A-1.7`

## 1. 개요

사용자 요청에 따라, 관리자가 특정 형식의 JSON 파일을 업로드하여 전체 조직도와 사용자 정보를 한 번에 동기화하는 기능을 개발했습니다. 이 기능은 조직의 초기 설정 및 대규모 개편 시 수동 작업을 최소화하고 휴먼 에러를 방지하는 데 목적이 있습니다.

## 2. 주요 변경 사항

### 2.1. API 엔드포인트 추가

- **`POST /api/v1/organizations/sync-chart`**
  - 관리자(`ADMIN`) 권한이 필요합니다.
  - `multipart/form-data` 형식으로 JSON 파일을 업로드받습니다.
  - 동기화 작업 완료 후, 생성 및 업데이트된 조직과 사용자의 수를 포함하는 통계 정보를 반환합니다.

### 2.2. 데이터 모델 및 스키마 확장

- **`app/models/user.py`**
  - `UserRole` Enum에 `CENTER_HEAD` 역할을 추가하여, 실장(`DEPT_HEAD`)보다 상위 직책(센터장, 연구소장 등)을 표현할 수 있도록 확장했습니다.
  - `User` 모델에 `title` (직급) 컬럼을 추가했습니다. (예: "부장", "선임연구원")

- **`app/schemas/user.py`**
  - `UserBase`, `UserCreate`, `UserUpdate` 스키마에 `title` 필드를 추가하여 API 레벨에서 직급 정보를 처리할 수 있도록 수정했습니다.

### 2.3. 동기화 로직 구현 (`app/crud/organization.py`)

`sync_organizations_and_users_from_json` 함수를 신규 작성하여 동기화 로직을 구현했습니다.

- **재귀적 처리:**
  - JSON 데이터의 계층 구조를 재귀적으로 탐색하며 각 조직과 그 하위 조직을 순서대로 처리합니다.

- **역할(Role) 자동 할당:**
  - `_get_leader_role` 헬퍼 함수를 통해 조직의 계층 구조상 위치를 기반으로 리더의 역할을 동적으로 결정합니다.
    - 하위 조직이 없으면 `TEAM_LEAD`
    - 하위 조직이 모두 팀(리프 노드)이면 `DEPT_HEAD`
    - 그 외 상위 조직은 `CENTER_HEAD`

- **사용자 생성 및 업데이트:**
  - `_process_user` 헬퍼 함수가 이메일 주소를 기준으로 기존 사용자 존재 여부를 확인합니다.
  - 사용자가 없으면, 이메일 ID를 `username`과 초기 `password`로 사용하여 새로운 사용자를 생성합니다. (비밀번호는 해시 처리)
  - 사용자가 이미 존재하면, 파일에 명시된 정보(이름, 직급, 소속 조직, 역할)로 기존 정보를 업데이트합니다.
  - 이메일이 없는 사용자는 `null@suresofttech.com`으로 처리합니다.

### 2.4. 테스트 코드 작성

- `tests/api/test_organizations.py`에 `test_sync_org_chart_by_admin` 테스트 케이스를 추가했습니다.
- 이 테스트는 실제와 유사한 계층 구조의 JSON 데이터를 사용하여 다음을 검증합니다.
  - 조직과 사용자의 정상적인 생성
  - 계층에 따른 역할(CENTER_HEAD, DEPT_HEAD, TEAM_LEAD)의 정확한 할당
  - 직급(`title`) 정보의 올바른 저장
  - 기존 기능에 대한 회귀(regression) 오류 부재 확인

## 3. 결론

위 변경 사항들을 통해 요구사항 `FR-A-1.7`을 충족하는 안정적인 동기화 기능을 구현했으며, 전체 테스트 통과를 통해 기능의 안정성을 확보했습니다.
