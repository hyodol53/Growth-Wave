# [요청] 평가 시스템 개선을 위한 백엔드 수정 요청

**문서 ID:** `REQ-BE-20251030-01`
**작성자:** 프론트엔드 에이전트
**요청일:** 2025-10-30

## 1. 개요

최근 구체화된 평가 정책에 따라, 기존 백엔드 시스템에 두 가지 주요 기능의 수정 및 구현이 필요하여 본 문서를 통해 공식적으로 요청합니다. 주요 내용은 **(1) 부서장 등급 자동 부여**와 **(2) 등급별 TO(정원) 계산 시 부서장 포함**입니다.

## 2. 상세 요구사항

### 2.1. 부서장 등급 자동 부여 (FR-A-4.3 신규 반영)

**- 배경**
- `FR-A-3.7`에 따라 센터장이 각 부서(실)에 S/A/B 등급을 부여하면, `FR-A-4.3` 정책에 의해 해당 부서의 장(실장)은 별도의 평가 절차 없이 소속 부서와 동일한 최종 등급을 자동으로 부여받아야 합니다.

**- 기술적 구현 요건**
1.  **부서 등급 설정을 위한 API 엔드포인트 구현**
    -   **엔드포인트 (제안):** `PUT /api/v1/organizations/{org_id}/grade`
    -   **요청 본문:** `{ "department_grade": "S" }`
    -   **권한:** `CENTER_HEAD` 또는 `ADMIN` 역할만 호출 가능해야 합니다.

2.  **부서장 등급 동기화 로직 구현**
    -   위 API가 호출될 때, 다음 두 작업이 하나의 트랜잭션(Transaction)으로 처리되어야 합니다.
        a.  `organizations` 테이블에서 해당 `org_id`의 `department_grade` 필드를 업데이트합니다.
        b.  해당 `org_id`를 소속으로 가지며 역할이 `DEPT_HEAD`인 사용자를 찾아, `final_evaluations` 테이블에 있는 해당 평가 기간의 레코드의 `grade` 필드를 (a)와 동일한 값으로 업데이트합니다. (레코드가 없으면 생성 후 업데이트)

---

### 2.2. 등급별 TO(정원) 계산 시 부서장 포함 (FR-A-2.2 수정 반영)

**- 배경**
- `FR-A-2.2` 정책에 따르면, 실장이 부서원에게 등급을 부여할 때 할당된 TO(정원)를 초과할 수 없습니다. 이때, TO 산출의 기준이 되는 **'총 부서원 수'에는 부서장(실장) 자신도 포함**되어야 합니다.

**- 기술적 구현 요건**
1.  **등급 조정 로직 내 TO 계산 기준 수정**
    -   **대상 API:** `POST /api/v1/evaluations/adjust-grades`
    -   **대상 로직:** `app/crud/grade_adjustment.py`의 `adjust_grades_for_department` 함수 (또는 관련 함수)
    -   **수정 내용:** 등급별 TO(예: S등급 TO = 총 부서원 수 * S등급 비율)를 계산할 때, '총 부서원 수'를 산정하는 로직에서 **`DEPT_HEAD` 역할의 사용자가 제외되지 않도록** 해야 합니다.

**- 예시 시나리오**
-   **조건:**
    -   A실 총 인원: 5명 (실장 1명, 팀원 4명)
    -   A실의 S등급 TO 비율: 20%
-   **기대 결과:**
    -   TO 계산 시 기준 인원: 5명
    -   A실에 부여 가능한 S등급 인원: 5 * 0.2 = 1명

## 3. 기타

-   상기 변경 사항에 대한 단위 테스트 및 통합 테스트 코드를 반드시 추가하여 기능의 안정성을 보장해 주시기 바랍니다.
-   관련하여 문의사항이 있을 경우 즉시 회신 부탁드립니다.

---